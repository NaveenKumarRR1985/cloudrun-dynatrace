{% extends "base.html" %}

{% block title %}Metrics - FastAPI OpenTelemetry{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-6"><i class="bi bi-graph-up text-primary"></i> Application Metrics</h1>
            <div class="btn-group">
                <button class="btn btn-outline-primary active" onclick="updateAllMetricsCharts()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Metrics -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer text-primary"></i> Real-time Performance
                </h5>
            </div>
            <div class="card-body">
                <canvas id="realtimeChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart text-success"></i> System Overview
                </h5>
            </div>
            <div class="card-body">
                <canvas id="overviewChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Metrics Cards -->
<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-server text-info"></i> System Health
                </h5>
            </div>
            <div class="card-body">
                <div class="metric-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>CPU Usage</span>
                        <span id="detailed-cpu">--</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-primary" id="cpu-progress"></div>
                    </div>
                </div>
                
                <div class="metric-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Memory Usage</span>
                        <span id="detailed-memory">--</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-success" id="memory-progress"></div>
                    </div>
                </div>
                
                <div class="metric-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Disk Usage</span>
                        <span id="detailed-disk">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" id="disk-progress"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity text-warning"></i> Application Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="stat-item d-flex justify-content-between align-items-center py-2">
                    <span><i class="bi bi-clock text-muted me-2"></i>Uptime</span>
                    <span class="badge bg-success" id="app-uptime">--</span>
                </div>
                <hr>
                <div class="stat-item d-flex justify-content-between align-items-center py-2">
                    <span><i class="bi bi-graph-up text-muted me-2"></i>Total Requests</span>
                    <span class="badge bg-primary" id="app-requests">--</span>
                </div>
                <hr>
                <div class="stat-item d-flex justify-content-between align-items-center py-2">
                    <span><i class="bi bi-people text-muted me-2"></i>Total Users</span>
                    <span class="badge bg-info" id="app-users">--</span>
                </div>
                <hr>
                <div class="stat-item d-flex justify-content-between align-items-center py-2">
                    <span><i class="bi bi-hdd text-muted me-2"></i>Memory (App)</span>
                    <span class="badge bg-secondary" id="app-memory">--</span>
                </div>
                <hr>
                <div class="stat-item d-flex justify-content-between align-items-center py-2">
                    <span><i class="bi bi-link text-muted me-2"></i>Connections</span>
                    <span class="badge bg-dark" id="app-connections">--</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check text-success"></i> OpenTelemetry Status
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Active</strong> - Traces are being collected
                </div>
                
                <div class="otel-info">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Service Name</small>
                        <small><code>fastapi-otel-demo</code></small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Version</small>
                        <small><code>1.0.0</code></small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Environment</small>
                        <small><span class="badge bg-warning">production</span></small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Status</small>
                        <small><i class="bi bi-check-circle text-success"></i> Running</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Network and Performance Stats -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-wifi text-info"></i> Network Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center mb-3">
                            <i class="bi bi-upload display-6 text-primary"></i>
                            <h4 class="mb-0" id="network-sent">--</h4>
                            <small class="text-muted">Bytes Sent</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center mb-3">
                            <i class="bi bi-download display-6 text-success"></i>
                            <h4 class="mb-0" id="network-recv">--</h4>
                            <small class="text-muted">Bytes Received</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="fw-bold" id="network-packets-sent">--</div>
                            <small class="text-muted">Packets Sent</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="fw-bold" id="network-packets-recv">--</div>
                            <small class="text-muted">Packets Received</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cpu text-warning"></i> System Details
                </h5>
            </div>
            <div class="card-body">
                <div class="system-details">
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span><i class="bi bi-processor text-muted me-2"></i>CPU Cores</span>
                        <span class="badge bg-primary" id="cpu-cores">--</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span><i class="bi bi-speedometer2 text-muted me-2"></i>CPU Frequency</span>
                        <span class="badge bg-info" id="cpu-freq">--</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span><i class="bi bi-memory text-muted me-2"></i>Total Memory</span>
                        <span class="badge bg-success" id="total-memory">--</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span><i class="bi bi-hdd-stack text-muted me-2"></i>Total Disk</span>
                        <span class="badge bg-warning" id="total-disk">--</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span><i class="bi bi-pc-display text-muted me-2"></i>Platform</span>
                        <span class="badge bg-secondary" id="platform-info">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables for metrics charts
let realtimeChart, overviewChart;
let metricsHistory = [];

// Initialize metrics page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing metrics page...');
    initializeMetricsCharts();
    updateMetricsData();
    setInterval(updateMetricsData, 3000); // Update every 3 seconds
});

// Initialize metrics charts
function initializeMetricsCharts() {
    setupRealtimeChart();
    setupOverviewChart();
}

// Setup realtime chart
function setupRealtimeChart() {
    const ctx = document.getElementById('realtimeChart');
    if (!ctx) {
        console.error('realtimeChart canvas not found');
        return;
    }

    realtimeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Response Time (ms)',
                data: [],
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'CPU %',
                data: [],
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 120
                }
            },
            animation: {
                duration: 0
            }
        }
    });
    console.log('Realtime chart initialized');
}

// Setup overview chart with real data
function setupOverviewChart() {
    const ctx = document.getElementById('overviewChart');
    if (!ctx) {
        console.error('overviewChart canvas not found');
        return;
    }

    overviewChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['CPU %', 'Memory %', 'Disk %', 'Users', 'Requests'],
            datasets: [{
                label: 'Current Values',
                data: [0, 0, 0, 0, 0],
                backgroundColor:[
                    'rgba(13, 110, 253, 0.8)',
                    'rgba(25, 135, 84, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(13, 202, 240, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderColor: [
                    'rgb(13, 110, 253)',
                    'rgb(25, 135, 84)',
                    'rgb(255, 193, 7)',
                    'rgb(13, 202, 240)',
                    'rgb(220, 53, 69)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    console.log('Overview chart initialized');
}

// Update metrics data
async function updateMetricsData() {
    try {
        console.log('Fetching metrics data...');
        const response = await fetch('/api/dashboard-data');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Metrics data received:', data);
        
        // Update detailed metrics
        updateDetailedMetrics(data);
        updateApplicationStats(data);
        updateNetworkStats(data);
        updateSystemDetails(data);
        
        // Update charts
        updateRealtimeChart(data);
        updateOverviewChart(data);
        
        console.log('Metrics updated successfully');
        
    } catch (error) {
        console.error('Error updating metrics:', error);
        
        // Show error state
        document.querySelectorAll('[id$="-cpu"], [id$="-memory"], [id$="-disk"]').forEach(el => {
            if (el) el.textContent = 'Error';
        });
    }
}

// Update detailed metrics
function updateDetailedMetrics(data) {
    const elements = {
        'detailed-cpu': `${data.system.cpu_percent.toFixed(1)}%`,
        'detailed-memory': `${data.system.memory_percent.toFixed(1)}%`,
        'detailed-disk': `${data.system.disk_percent.toFixed(1)}%`,
        'cpu-progress': data.system.cpu_percent,
        'memory-progress': data.system.memory_percent,
        'disk-progress': data.system.disk_percent
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            if (id.includes('progress')) {
                element.style.width = `${value}%`;
            } else {
                element.textContent = value;
            }
        }
    });
}

// Update application stats
function updateApplicationStats(data) {
    const uptime = Math.floor(data.app.uptime_seconds);
    const hours = Math.floor(uptime / 3600);
    const minutes = Math.floor((uptime % 3600) / 60);
    
    const stats = {
        'app-uptime': `${hours}h ${minutes}m`,
        'app-requests': data.app.total_requests,
        'app-users': data.app.total_users,
        'app-memory': `${data.app.memory_usage_mb.toFixed(1)} MB`,
        'app-connections': data.app.active_connections
    };
    
    Object.entries(stats).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    });
}

// Update network stats
function updateNetworkStats(data) {
    const formatBytes = (bytes) => {
        if (bytes >= 1024 * 1024 * 1024) {
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        } else if (bytes >= 1024 * 1024) {
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        } else if (bytes >= 1024) {
            return (bytes / 1024).toFixed(2) + ' KB';
        }
        return bytes + ' B';
    };
    
    const formatNumber = (num) => {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    };
    
    const networkStats = {
        'network-sent': formatBytes(data.system.network_bytes_sent),
        'network-recv': formatBytes(data.system.network_bytes_recv),
        'network-packets-sent': formatNumber(data.system.network_packets_sent),
        'network-packets-recv': formatNumber(data.system.network_packets_recv)
    };
    
    Object.entries(networkStats).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    });
}

// Update system details
function updateSystemDetails(data) {
    const systemDetails = {
        'cpu-cores': data.system.cpu_count,
        'cpu-freq': `${(data.system.cpu_freq_current/1000).toFixed(1)} GHz`,
        'total-memory': `${data.system.memory_total_gb} GB`,
        'total-disk': `${data.system.disk_total_gb} GB`,
        'platform-info': data.system.platform
    };
    
    Object.entries(systemDetails).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    });
}

// Update realtime chart
function updateRealtimeChart(data) {
    if (!realtimeChart) {
        console.warn('Realtime chart not initialized');
        return;
    }
    
    const now = new Date().toLocaleTimeString();
    const responseTime = Math.random() * 50 + 30; // Simulated response time
    
    // Add new data point
    realtimeChart.data.labels.push(now);
    realtimeChart.data.datasets[0].data.push(responseTime);
    realtimeChart.data.datasets[1].data.push(data.system.cpu_percent);
    
    // Keep only last 20 data points
    if (realtimeChart.data.labels.length > 20) {
        realtimeChart.data.labels.shift();
        realtimeChart.data.datasets[0].data.shift();
        realtimeChart.data.datasets[1].data.shift();
    }
    
    realtimeChart.update('none');
}

// Update overview chart with real data
function updateOverviewChart(data) {
    if (!overviewChart) {
        console.warn('Overview chart not initialized');
        return;
    }
    
    // Scale values appropriately for visualization
    const requestsScale = Math.min(data.app.total_requests * 5, 100); // Scale requests to fit 0-100
    const usersScale = Math.min(data.app.total_users * 20, 100); // Scale users to fit 0-100
    
    overviewChart.data.datasets[0].data = [
        data.system.cpu_percent,
        data.system.memory_percent,
        data.system.disk_percent,
        usersScale,
        requestsScale
    ];
    
    overviewChart.update('none');
    console.log('Overview chart updated with real data');
}

// Function to refresh all charts
function updateAllMetricsCharts() {
    console.log('Manually refreshing all metrics charts...');
    updateMetricsData();
    showToast('Charts updated!', 'info');
}

// Toast notification function
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
